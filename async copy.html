<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Weather</title>
  </head>

  <body>

    <h1>Weather App</h1>
    <h3>Please enter a U.S. city and state.</h3>

    <form class='searchCity'>
        <input type="text" placeholder="Orlando, Florida">
        <button type="submit" class="searchButton">Search</button>
        <button type="submit" class="previousButton">Previous</button>
    </form>

    <div>
        <p class='firstCity'> </p>
        <div id='viewMoreOne'> </div>
        <div id='returnOne'> </div>
    </div>

    <div>
        <p class='secondCity'> </p>
        <div id='viewMoreTwo'> </div>
        <div id='returnTwo'> </div>
    </div>

    <div>
        <p class='thirdCity'> </p>
        <div id='viewMoreThree'> </div>
        <div id='returnThree'> </div>
    </div>

    <div>
        <p class='previousCity'></p>
    </div>

    <script>
        let weatherObj;
        let emptyString = '';
        
        let previousCity = 'HELLO';
        let previousCityTwo = 'WORLD';
        let threeCitiesSave = [];
        
        let btn;
        let currentTemp = 'currentTemp';
        let searchMore = 'searchMore';
        let OnLoadCount = 0;
        let i = 0;
        let loadCounter = 0;
        let savedLocations;
        let firstLocation;
        let secondLocation;
        let thirdLocation;
        let savedCities; 
        let jsonOne;
        let jsonTwo;
        let jsonThree;

        // on-load Fetch
        if (emptyString !== '')
        {
            postData('http://localhost:8080/locations', emptyString)
        }
        
        fetch('http://localhost:8080/locations')
        .then(response => response.json())
        .then(json => {
            if (loadCounter == 0){
                return displayFirst(json);
            }
            else if (loadCounter == 1)
            {
                return displaySecond(json);
            }
            else{
                return displayThird(json);
            }
        })

         // POST to http://localhost:8080/locations
        function postData(serverURL, cityString) {
            fetch(serverURL, {
                method: 'POST', 
                mode: 'no-cors', 
                cache: 'no-cache', 
                credentials: 'same-origin', 
                headers: {'Content-Type': 'application/json','Access-Control-Allow-Origin' : '*'},
                body: JSON.stringify(cityString) // body data type must match "Content-Type" header
            })
        }

        // Fetch weather API
        async function getJSON(city, state, count){
            const url = 'http://api.openweathermap.org/data/2.5/weather?q=' + city + "," + state + '&appid=f561787d1d228ebb3f7ab09e4729c788&units=imperial';  
            const response =  await fetch(url).then(response => response.json())
            if (count == 0){
                return firstLocation = response;
            }
            else if (count == 1){
                return secondLocation = response;
            }
            else{
                return thirdLocation = response;
            }
                
        }

        async function displayFirst(jsonData){
            document.querySelector(".firstCity").innerHTML = "The current temperature in " + jsonOne.name + " is " + jsonOne.main.temp + " degrees fahrenheit.";
            document.getElementById("viewMoreOne").innerHTML = '<button>View More</button>';
            document.getElementById("viewMoreOne").style.display = 'inline';
            document.getElementById("returnOne").style.display = 'none';
            i++;
        }

        async function displaySecond(jsonData){
            document.querySelector(".secondCity").innerHTML = "The current temperature in " + jsonTwo.name + " is " + jsonTwo.main.temp + " degrees fahrenheit.";
            document.getElementById("viewMoreTwo").innerHTML = '<button>View More</button>';
            document.getElementById("viewMoreTwo").style.display = 'inline';
            document.getElementById("returnTwo").style.display = 'none';
            i++;
        }

        async function displayThird(jsonData){
            document.querySelector(".thirdCity").innerHTML = "The current temperature in " + jsonThree.name + " is " + jsonThree.main.temp + " degrees fahrenheit.";
            document.getElementById("viewMoreThree").innerHTML = '<button>View More</button>';
            document.getElementById("viewMoreThree").style.display = 'inline';
            document.getElementById("returnThree").style.display = 'none';
            i++;
        }


        
        // Event handler searches city weather API on submit
        // Adds city to server array
        let searchBtn = document.querySelector('.searchButton');  

        searchBtn.onclick = async function(event){

	        // prevents page refreshing
	        event.preventDefault();

	        // add task to array
	        let input = document.querySelector('input');
            let formEntry = input.value.split(',');
		    input.value = '';   

            var cityEnteredString= formEntry.toString();

            // saving previous city search for "previous" button
            previousCityTwo = previousCity;
            previousCity = cityEnteredString;
            
            // saving searches to server
            postData('http://localhost:8080/locations', cityEnteredString)

            // display current temperature at city to div 1,2, or 3
            if (i == 0){
                jsonOne = await getJSON(formEntry[0], formEntry[1], i)
                displayFirst(jsonOne);
                
            }
            else if (i == 1){
                let jsonTwo = await getJSON(formEntry[0], formEntry[1], i)
                displaySecond(jsonTwo);
            }    
            else{
                let jsonThree = await getJSON(formEntry[0], formEntry[1], i)
                displayThird(jsonThree);
            }
            
        };


        






/*
        // GET array of searched cities from server
        document.querySelector('.previousButton').onclick = function(event){
            event.preventDefault();
            document.querySelector(".previousCity").innerHTML = "The previous city is " + previousCityTwo;
        };

        document.querySelector('#viewMoreOne').onclick = function(event){
            event.preventDefault();
            let viewCount = 0;
            let firstSearch;   
            searchTemps(firstSearch[0], firstSearch[1], viewCount);
            document.querySelector(".firstCity").innerHTML = "The current temperature in " + weatherObj.name + " is " + weatherObj.main.temp + " degrees fahrenheit.";
            document.getElementById("viewMoreOne").innerHTML = '<button>View More</button>';
            document.getElementById("viewMoreOne").style.display = 'inline';
            document.getElementById("returnOne").style.display = 'none';
            
        };

        document.querySelector('#viewMoreTwo').onclick = function(event){
            event.preventDefault();
            let viewCount = 1

            let secondSearch;

            fetch('http://localhost:8080/locations')
            .then(response => response.json())
            .then(json => {
                myCities = json;
            })
            .then(()  => {
                secondSearch = myCities[0].split(",");
                searchTemps(secondSearch[0], secondSearch[1], viewCount, searchMore);
            })
        };

        document.querySelector('#viewMoreThree').onclick = function(event){
            event.preventDefault();
            let viewCount = 2
            let thirdSearch;

            fetch('http://localhost:8080/locations')
            .then(response => response.json())
            .then(json => {
                myCities = json;
            })
            .then(()  => {
                thirdSearch = myCities[0].split(",");
                searchTemps(thirdSearch[0], thirdSearch[1], viewCount, searchMore);
            })
        };

        document.querySelector('#returnOne').onclick = function(event){
            event.preventDefault();
            let viewCount = 0;

            fetch('http://localhost:8080/locations')
            .then(response => response.json())
            .then(json => {
                myCities = json;
            })
            .then(()  => {
                firstSearch = myCities[0].split(",");
                searchTemps(firstSearch[0], firstSearch[1], viewCount, currentTemp);
            })

        }
*/
        /*
        TODO: Fetch each JSON once and save each to use for viewMore/return instead of fetching a ton?
        */
        
    </script>

  </body>
</html>