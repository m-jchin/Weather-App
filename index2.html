<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Weather</title>
  </head>

  <body>

    <h1>Weather App</h1>
    <h3>Please enter a U.S. city and state.</h3>

    <form class='searchCity'>
        <input type="text" placeholder="Orlando, Florida">
        <button type="submit" class="searchButton">Search</button>
        <button type="submit" class="previousButton">Previous</button>
    </form>

    <div>
        <p class='firstCity'> </p>
        <div id='viewMoreOne'> </div>
        <div id='returnOne'> </div>
    </div>

    <div>
        <p class='secondCity'> </p>
        <div id='viewMoreTwo'> </div>
        <div id='returnTwo'> </div>
    </div>

    <div>
        <p class='thirdCity'> </p>
        <div id='viewMoreThree'> </div>
        <div id='returnThree'> </div>
    </div>

    <div>
        <p class='previousCity'></p>
    </div>

    <script>
        const baseURL = 'api.openweathermap.org';
        const key = "f561787d1d228ebb3f7ab09e4729c788";
        //const url = 'http://api.openweathermap.org/data/2.5/weather?zip=32817,us&appid=f561787d1d228ebb3f7ab09e4729c788&units=imperial';
        let weatherObj;
        let emptyString = '';
        let myCities; 
        let previousCity = 'HELLO';
        let previousCityTwo = 'WORLD';
        let threeCitiesSave = [];
        let i = 0;
        let loadCounter = 0;
        let btn;
        let currentTemp = 'currentTemp';
        let searchMore = 'searchMore';
        

        // on-load Fetch
        if (emptyString !== '')
        {
            postData('http://localhost:8080/locations', emptyString)
        }

        fetch('http://localhost:8080/locations')
        .then(response => response.json())
        .then(json => {
            myCities = json 
            if (myCities.length){
                console.log("yeehaw!")
                while (loadCounter !== 3){
                  let onLoadLocation = myCities[loadCounter].split(",")
                  console.log(onLoadLocation)
                  searchTemps(onLoadLocation[0], onLoadLocation[1], loadCounter, currentTemp)
                  loadCounter++;
                }
                console.log(myCities)
            }
            else{
                console.log("Nooooo!!!!!!!")
            }
        })
        

        // Fetch weather API
        function searchTemps(city, state, count, searchType){
            const urlOne = 'http://api.openweathermap.org/data/2.5/weather?q=' + city + "," + state + '&appid=f561787d1d228ebb3f7ab09e4729c788&units=imperial';
            

            // this section displays current temperatures for the city searched
            if (searchType == "currentTemp"){ 
                if (count == 0){
                    fetch(urlOne).then(function(response){
                        response.json()
                        .then(response => weatherObj = response)
                        .then(() => document.querySelector(".firstCity").innerHTML = "The current temperature in " + weatherObj.name + " is " + weatherObj.main.temp + " degrees fahrenheit.") 
                        .then(() =>  document.getElementById("viewMoreOne").innerHTML = '<button>View More</button>')
                        .then(() => document.getElementById("viewMoreOne").style.display = 'inline')
                        .then(() => document.getElementById("returnOne").style.display = 'none');
                    });
                }
                else if (count == 1){
                    fetch(urlOne).then(function(response){
                        response.json()
                        .then(response => weatherObj = response)
                        .then(() => document.querySelector(".secondCity").innerHTML = "The current temperature in " + weatherObj.name + " is " + weatherObj.main.temp + " degrees fahrenheit.") 
                        .then(() =>  document.getElementById("viewMoreTwo").innerHTML = '<button>View More</button>');
                    });
                }
                else{
                    fetch(urlOne).then(function(response){
                        response.json()
                        .then(response => weatherObj = response)
                        .then(() => document.querySelector(".thirdCity").innerHTML = "The current temperature in " + weatherObj.name + " is " + weatherObj.main.temp + " degrees fahrenheit.") 
                        .then(() =>  document.getElementById("viewMoreThree").innerHTML = '<button>View More</button>');
                    });
                }
            }
            else if(searchType == "searchMore"){ // this section displays more weather information when View More is pressed
                if (count == 0){
                    fetch(urlOne).then(function(response){
                        response.json()
                        .then(response => {
                            weatherObj = response;
                            document.querySelector(".firstCity").innerHTML  = `<p>Weather conditions: ${weatherObj.weather[0].main}<br>Feels Like: ${weatherObj.main.feels_like} degrees Fahrenheit<br>Wind Speed: ${weatherObj.wind.speed}mph </p>`;
                            document.getElementById("viewMoreOne").style.display = 'none';
                            document.getElementById("returnOne").innerHTML = '<button>Return</button>';
                            document.getElementById("returnOne").style.display = 'inline';
                        })     
                    });
                }
                else if (count == 1){
                    fetch(urlOne).then(function(response){
                        response.json()
                        .then(response => {
                            weatherObj = response;
                            document.querySelector(".secondCity").innerHTML  = `<p>Weather conditions: ${weatherObj.weather[0].main}<br>Feels Like: ${weatherObj.main.feels_like} degrees Fahrenheit<br>Wind Speed: ${weatherObj.wind.speed}mph </p>`;
                            document.getElementById("viewMoreTwo").style.display = 'none';
                            document.getElementById("returnTwo").innerHTML = '<button>Return</button>';
                        })     
                    });
                }
                else{
                    fetch(urlOne).then(function(response){
                        response.json()
                        .then(response => {
                            weatherObj = response;
                            document.querySelector(".thirdCity").innerHTML  = `<p>Weather conditions: ${weatherObj.weather[0].main}<br>Feels Like: ${weatherObj.main.feels_like} degrees Fahrenheit<br>Wind Speed: ${weatherObj.wind.speed}mph </p>`;
                            document.getElementById("viewMoreThree").style.display = 'none';
                            document.getElementById("returnThree").innerHTML = '<button>Return</button>';
                        })     
                    });
                }
            }
        }

        

         // POST to http://localhost:8080/locations
        function postData(serverURL, cityString) {
            fetch(serverURL, {
                method: 'POST', 
                mode: 'no-cors', 
                cache: 'no-cache', 
                credentials: 'same-origin', 
                headers: {'Content-Type': 'application/json','Access-Control-Allow-Origin' : '*'},
                body: JSON.stringify(cityString) // body data type must match "Content-Type" header
            })
        }

        // Event handler searches city weather API on submit
        // Adds city to server array
        let searchBtn = document.querySelector('.searchButton');  
        searchBtn.onclick = function(event){

	        // prevents page refreshing
	        event.preventDefault();

	        // add task to array
	        let input = document.querySelector('input');
            let formEntry = input.value.split(',');
            // console.log(formEntry); // formEntry currently array of location
		    input.value = '';   

            var cityEnteredString= formEntry.toString();
            //console.log(cityEnteredString);  // toString ["Austin","Texas"] -> "Austin, Texas"

            // saving previous city search for "previous" button
            previousCityTwo = previousCity;
            previousCity = cityEnteredString;
            
            // saving searches to server
            postData('http://localhost:8080/locations', cityEnteredString)

            // display current temperature at city to div 1,2, or 3
            if (i == 2){
                //threeCitiesDisplay[i] = cityEnteredString;
                searchTemps(formEntry[0], formEntry[1], i, currentTemp);
                i = 0;
            }
            else{
                //threeCitiesDisplay[i] = cityEnteredString;
                searchTemps(formEntry[0], formEntry[1], i, currentTemp);
                i++;
            }
        };

        // GET array of searched cities from server
        document.querySelector('.previousButton').onclick = function(event){
            event.preventDefault();
            document.querySelector(".previousCity").innerHTML = "The previous city is " + previousCityTwo;
        };

        document.querySelector('#viewMoreOne').onclick = function(event){
            event.preventDefault();
            let viewCount = 0;
            let firstSearch;

            fetch('http://localhost:8080/locations')
            .then(response => response.json())
            .then(json => {
                myCities = json;
            })
            .then(()  => {
                firstSearch = myCities[0].split(",");
                searchTemps(firstSearch[0], firstSearch[1], viewCount, searchMore);
            })
         
        };

        document.querySelector('#viewMoreTwo').onclick = function(event){
            event.preventDefault();
            let viewCount = 1

            let secondSearch;

            fetch('http://localhost:8080/locations')
            .then(response => response.json())
            .then(json => {
                myCities = json;
            })
            .then(()  => {
                secondSearch = myCities[0].split(",");
                searchTemps(secondSearch[0], secondSearch[1], viewCount, searchMore);
            })
        };

        document.querySelector('#viewMoreThree').onclick = function(event){
            event.preventDefault();
            let viewCount = 2
            let thirdSearch;

            fetch('http://localhost:8080/locations')
            .then(response => response.json())
            .then(json => {
                myCities = json;
            })
            .then(()  => {
                thirdSearch = myCities[0].split(",");
                searchTemps(thirdSearch[0], thirdSearch[1], viewCount, searchMore);
            })
        };

        document.querySelector('#returnOne').onclick = function(event){
            event.preventDefault();
            let viewCount = 0;

            fetch('http://localhost:8080/locations')
            .then(response => response.json())
            .then(json => {
                myCities = json;
            })
            .then(()  => {
                firstSearch = myCities[0].split(",");
                searchTemps(firstSearch[0], firstSearch[1], viewCount, currentTemp);
            })

        }

        /*
        TODO: Fetch each JSON once and save each to use for viewMore/return instead of fetching a ton?
        */
        
    </script>

  </body>
</html>
