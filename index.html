<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <title>Weather</title>
  </head>

  <body>
    <div id='flexContainerSearch'>
        <div id='searchColumn'>
            <h1>Weather App</h1>
            <p>Please enter a U.S. city and state.</p>

            <form class='searchCity'>
                <input type="text" placeholder="Orlando, Florida">
                <button type="submit" class="searchButton">Search</button>
            </form>
        </div>
    </div>

    <div id='flexContainerContent'>
        <div id='first'>
            <p class='firstCity'> </p>
            <div id='viewMoreOne'> </div>
            <div id='returnOne'> </div>
        </div>

        <div id = 'second'>
            <p class='secondCity'> </p>
            <div id='viewMoreTwo'> </div>
            <div id='returnTwo'> </div>
        </div>

        <div id = 'third'>
            <p class='thirdCity'> </p>
            <div id='viewMoreThree'> </div>
            <div id='returnThree'> </div>
        </div>
    </div>


    <script>
        const baseURL = 'api.openweathermap.org';
        const key = "f561787d1d228ebb3f7ab09e4729c788";
        //const url = 'http://api.openweathermap.org/data/2.5/weather?zip=32817,us&appid=f561787d1d228ebb3f7ab09e4729c788&units=imperial';
        let weatherObj;
        let emptyString = '';
        
        let previousCity = 'HELLO';
        let previousCityTwo = 'WORLD';
        let threeCitiesSave = [];
        let i = 0;
        let loadCounter = 0;
        let btn;
        let currentTemp = 'currentTemp';
        let searchMore = 'searchMore';
        

        let sizeOfServerArray;
        let serverCities; 
        let cityJsons = [];     
        let abc;

        
            
        
        
        // POST to http://localhost:8080/locations
        function postData(serverURL, cityString) {
            fetch(serverURL, {
                method: 'POST', 
                mode: 'no-cors', 
                cache: 'no-cache', 
                credentials: 'same-origin', 
                headers: {'Content-Type': 'application/json','Access-Control-Allow-Origin' : '*'},
                body: JSON.stringify(cityString) // body data type must match "Content-Type" header
            })
        }

        async function getWeatherJson(location){
            const url = 'http://api.openweathermap.org/data/2.5/weather?q=' + location + '&appid=f561787d1d228ebb3f7ab09e4729c788&units=imperial';
            let response = await fetch(url).then(response => response.json())
            return response; 
        }

        async function startup(){ // fetch array from server 
            

            let myCities = await fetch('http://localhost:8080/locations')
            .then(response => response.json())
            .then(json => {
                x = json; 
                return x;
            })

            
            console.log(x);
            if (!(myCities.length)){
                console.log("No information present!")
                return serverCities = [];
            }
            else{
                sizeOfServerArray = myCities.length
                return myCities; // return the array that was recevied from the server 
            }
        }

        async function startUpTwo(){        

            serverCities = await startup(); //serverCities is an array here*
            console.log(serverCities)

            if  (serverCities.length > 0){ // here we are getting the weather JSON for each location in the array
                for (let w = 0; w < serverCities.length; w++){
                    cityJsons[w] = await getWeatherJson(serverCities[w]);
                }
                
                console.log(serverCities) // should print array location strings 
                console.log(cityJsons); // should print array of weather JSONs

                for (let j = 0; j < serverCities.length; j++){
                    searchTemps(cityJsons[j], j, currentTemp)  // startup load of each location temperatures
                }
                

                // determining how many weather information divs to display on load
                if (sizeOfServerArray == 3){
                    document.querySelector("#first").style.display = 'inline';
                    document.querySelector("#second").style.display = 'inline';
                    document.querySelector("#third").style.display = 'inline';
                    i=3;
                }
                else if (sizeOfServerArray == 2){
                    document.querySelector("#first").style.display = 'inline';
                    document.querySelector("#second").style.display = 'inline';
                    i = 2;
                }
                else if (sizeOfServerArray == 1){
                    document.querySelector("#first").style.display = 'inline';
                    i=1;
                }
                else{
                    document.querySelector("#first").style.display = 'none';
                    document.querySelector("#second").style.display = 'none';
                    document.querySelector("#third").style.display = 'none';
                }
                //return cityJsons;
            }
        }

        // create event handlers for each "View More Button"
        let viewMoreOneBtn = document.querySelector('#viewMoreOne');  
        viewMoreOneBtn.onclick =  function(event){
            
	        // prevents page refreshing
	        event.preventDefault();

            //console.log(abc)
            searchTemps(cityJsons[0], 0, searchMore);

        };

        let viewMoreTwoBtn = document.querySelector('#viewMoreTwo');  
        viewMoreTwoBtn.onclick =  function(event){
            
	        // prevents page refreshing
	        event.preventDefault();

            //console.log(abc)
            searchTemps(cityJsons[1],1, searchMore);

        };

        let viewMoreThreeBtn = document.querySelector('#viewMoreThree');  
        viewMoreThreeBtn.onclick =  function(event){
            
	        // prevents page refreshing
	        event.preventDefault();

            //console.log(abc)
            searchTemps(cityJsons[2],2, searchMore);

        };

        // Event handler searches city weather API on submit
        // Adds city to server array
        let searchBtn = document.querySelector('.searchButton');  
        searchBtn.onclick = async function(event){
            
	        // prevents page refreshing
	        event.preventDefault();

	        // add task to array
	        let input = document.querySelector('input');
            let formEntry = input.value.split(',');
		    input.value = '';   

            let cityEnteredString= formEntry.toString();
            
            
            // saving searches to server
            postData('http://localhost:8080/locations', cityEnteredString)
            

            // display current temperature at city to div 1,2, or 3
            if (i == 2){
                document.querySelector('#third').style.display = 'inline';
                let a = await fetch('http://api.openweathermap.org/data/2.5/weather?q=' + cityEnteredString + '&appid=f561787d1d228ebb3f7ab09e4729c788&units=imperial')
                        .then(response => response.json())
                        .then(json => cityJsons[i] = json);
                
                console.log(a)
                console.log(i)         
                searchTemps(a, i, currentTemp);
                i = 0;
            }
            else{ 
                let a = await fetch('http://api.openweathermap.org/data/2.5/weather?q=' + cityEnteredString + '&appid=f561787d1d228ebb3f7ab09e4729c788&units=imperial')
                        .then(response => response.json())
                        .then(json => cityJsons[i] = json);

                console.log(a)
                console.log(cityJsons[i])
                console.log(i)
                searchTemps(a, i, currentTemp);
                i++;
            }
        }; 

        let returnOne  = document.querySelector('#returnOne');  
        returnOne.onclick =  function(event){
            
	        // prevents page refreshing
	        event.preventDefault();

            //console.log(abc)
            //i = 1;
            searchTemps(cityJsons[0],0, currentTemp);

        };

        let returnTwo  = document.querySelector('#returnTwo');  
        returnTwo.onclick =  function(event){
            
	        // prevents page refreshing
	        event.preventDefault();
            //i = 2;
            //console.log(abc)
            searchTemps(cityJsons[1],1, currentTemp);

        };

        let returnThree  = document.querySelector('#returnThree');  
        returnThree.onclick =  function(event){
            
	        // prevents page refreshing
	        event.preventDefault();

            //console.log(abc)
            
            searchTemps(cityJsons[2],2, currentTemp);

        };

        // Fetch weather API
        function searchTemps(weatherObject, count, searchType){
            
            // this section displays current temperatures for the city searched
            if (searchType == "currentTemp"){ 
                if (count == 0){ 
                    document.querySelector("#first").style.display = 'inline';
                    document.querySelector(".firstCity").innerHTML =   weatherObject.name + ": " + weatherObject.main.temp + " degrees fahrenheit."
                    document.getElementById("viewMoreOne").innerHTML = '<button>View More</button>'
                    document.getElementById("viewMoreOne").style.display = 'inline'
                    document.getElementById("returnOne").style.display = 'none' 
                }
                else if (count == 1){   
                    document.querySelector("#second").style.display = 'inline';          
                    document.querySelector(".secondCity").innerHTML = weatherObject.name + ": " + weatherObject.main.temp + " degrees fahrenheit."
                    document.getElementById("viewMoreTwo").innerHTML = '<button>View More</button>'
                    document.getElementById("viewMoreTwo").style.display = 'inline'
                    document.getElementById("returnTwo").style.display = 'none' 
        
                }
                else{    
                    document.querySelector("#third").style.display = 'inline';
                    document.querySelector(".thirdCity").innerHTML = weatherObject.name + ": " + weatherObject.main.temp + " degrees fahrenheit."
                    document.getElementById("viewMoreThree").innerHTML = '<button>View More</button>';  
                    document.getElementById("viewMoreThree").style.display = 'inline'
                    document.getElementById("returnThree").style.display = 'none' 
                }
            }
            else if(searchType == "searchMore"){ // this section displays more weather information when View More is pressed
                if (count == 0){
                    
                    document.querySelector(".firstCity").innerHTML  = `<p>Weather conditions: ${weatherObject.weather[0].main}<br>Feels Like: ${weatherObject.main.feels_like} degrees Fahrenheit<br>Wind Speed: ${weatherObject.wind.speed}mph </p>`;
                    document.getElementById("viewMoreOne").style.display = 'none';
                    document.getElementById("returnOne").innerHTML = '<button>Return</button>';
                    document.getElementById("returnOne").style.display = 'inline';  
                }
                else if (count == 1){
                    
                    document.querySelector(".secondCity").innerHTML  = `<p>Weather conditions: ${weatherObject.weather[0].main}<br>Feels Like: ${weatherObject.main.feels_like} degrees Fahrenheit<br>Wind Speed: ${weatherObject.wind.speed}mph </p>`;
                    document.getElementById("viewMoreTwo").style.display = 'none';
                    document.getElementById("returnTwo").innerHTML = '<button>Return</button>';
                    document.getElementById("returnTwo").style.display = 'inline';  
                }
                else{    
                    document.querySelector("#third").style.display = 'inline';
                    document.querySelector(".thirdCity").innerHTML  = `<p>Weather conditions: ${weatherObject.weather[0].main}<br>Feels Like: ${weatherObject.main.feels_like} degrees Fahrenheit<br>Wind Speed: ${weatherObject.wind.speed}mph </p>`;
                    document.getElementById("viewMoreThree").style.display = 'none';
                    document.getElementById("returnThree").innerHTML = '<button>Return</button>';
                    document.getElementById("returnThree").style.display = 'inline';  

                }
            }
        }   

       startUpTwo();

        
    </script>

  </body>
</html>